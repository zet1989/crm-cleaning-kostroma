# 🤖 AI Обработка заявок

## Концепция

Заявки приходят в **сыром виде** (весь текст в одном поле), а затем **AI автоматически извлекает** структурированные данные.

### Преимущества:
- ✅ Работает с любым форматом входных данных
- ✅ Не нужно настраивать парсинг для каждого источника
- ✅ AI понимает естественный язык
- ✅ Автоматическое заполнение полей сделки

---

## Как это работает

```
┌─────────────────────────────────────────────────────────────┐
│ 1. WEBHOOK ПОЛУЧАЕТ ДАННЫЕ                                  │
│    - Сайт отправляет форму                                  │
│    - Email с заявкой                                        │
│    - Транскрипция звонка                                    │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. СОХРАНЕНИЕ В БД                                          │
│    INSERT INTO deals (                                      │
│      notes = "Весь текст заявки",                          │
│      client_name = "Новая заявка",                         │
│      ... остальные поля пустые                             │
│    )                                                        │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. AI ОБРАБОТКА (автоматическая или по кнопке)             │
│    POST /api/ai/process-deal                                │
│    {                                                        │
│      "deal_id": "uuid"                                     │
│    }                                                        │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. AI ИЗВЛЕКАЕТ ДАННЫЕ                                      │
│    {                                                        │
│      "client_name": "Иван Петров",                         │
│      "client_phone": "+79991234567",                       │
│      "address": "ул. Ленина 123, кв. 45",                  │
│      "scheduled_at": "2025-12-15T14:00:00",                │
│      "price": 5000,                                        │
│      "cleaning_type": "генеральная"                        │
│    }                                                        │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 5. ОБНОВЛЕНИЕ СДЕЛКИ                                        │
│    UPDATE deals SET                                         │
│      client_name = "Иван Петров",                          │
│      client_phone = "+79991234567",                        │
│      address = "ул. Ленина 123, кв. 45",                   │
│      ...                                                    │
│    WHERE id = deal_id                                      │
└─────────────────────────────────────────────────────────────┘
```

---

## Примеры входных данных

### 1. Заявка с сайта (неструктурированная)
```
Здравствуйте! Меня зовут Иван Петров, телефон +7 999 123-45-67.
Нужна генеральная уборка трёхкомнатной квартиры 15 декабря в 14:00.
Адрес: ул. Ленина 123, кв. 45.
Окна тоже помыть нужно. Сколько будет стоить?
```

**AI извлечёт:**
```json
{
  "client_name": "Иван Петров",
  "client_phone": "+79991234567",
  "address": "ул. Ленина 123, кв. 45",
  "scheduled_at": "2025-12-15T14:00:00",
  "cleaning_type": "генеральная"
}
```

### 2. Email заявка
```
От: petr@mail.ru
Тема: Уборка после ремонта

Добрый день!
Закончили ремонт в офисе (Радионова 178), много пыли и строймусора.
Нужна уборка завтра с утра, свяжитесь пожалуйста 8 988 777-66-55
Петр
```

**AI извлечёт:**
```json
{
  "client_name": "Петр",
  "client_phone": "+79887776655",
  "address": "Радионова 178",
  "cleaning_type": "после ремонта"
}
```

### 3. Транскрипция звонка
```
Менеджер: Добрый день, клининговая компания!
Клиент: Да здравствуйте, Анна Сидорова. Хочу заказать уборку квартиры.
Менеджер: Когда вам удобно?
Клиент: Во вторник, числа 10-го, часов в 11. Живу на Гагарина 50.
Менеджер: Ваш телефон?
Клиент: +7 911 222-33-44
```

**AI извлечёт:**
```json
{
  "client_name": "Анна Сидорова",
  "client_phone": "+79112223344",
  "address": "Гагарина 50",
  "scheduled_at": "2025-12-10T11:00:00",
  "cleaning_type": "стандартная"
}
```

---

## API Endpoints

### POST `/api/ai/process-deal`

Обработать заявку с помощью AI.

**Request:**
```json
{
  "deal_id": "uuid-сделки"
}
```

**Response (успех):**
```json
{
  "success": true,
  "deal": {
    "id": "...",
    "client_name": "Иван Петров",
    "client_phone": "+79991234567",
    ...
  },
  "ai_result": {
    "client_name": "Иван Петров",
    "client_phone": "+79991234567",
    "address": "ул. Ленина 123, кв. 45",
    "scheduled_at": "2025-12-15T14:00:00",
    "price": 5000
  }
}
```

**Response (ошибка):**
```json
{
  "error": "Deal not found"
}
```

---

## Использование в интерфейсе

### Вариант 1: Автоматическая обработка (рекомендуется)

В webhook после создания сделки:
```typescript
// Создали сделку
const { data: deal } = await supabase.from('deals').insert({ ... })

// Автоматически запускаем AI обработку
await fetch('/api/ai/process-deal', {
  method: 'POST',
  body: JSON.stringify({ deal_id: deal.id })
})
```

### Вариант 2: Кнопка в карточке сделки

Добавить кнопку "🤖 Обработать AI" в модальное окно сделки:

```tsx
<Button 
  onClick={async () => {
    const res = await fetch('/api/ai/process-deal', {
      method: 'POST',
      body: JSON.stringify({ deal_id: deal.id })
    })
    const result = await res.json()
    // Обновить UI с новыми данными
  }}
>
  🤖 Обработать AI
</Button>
```

---

## Настройка OpenRouter API

1. Зарегистрируйтесь на https://openrouter.ai
2. Создайте API ключ
3. Добавьте в `.env.local`:
```env
OPENROUTER_API_KEY=sk-or-v1-...
```

### Модели (рекомендации):

| Модель | Скорость | Цена | Качество |
|--------|----------|------|----------|
| `openai/gpt-4o-mini` | ⚡⚡⚡ | 💰 | ⭐⭐⭐⭐ |
| `openai/gpt-4o` | ⚡⚡ | 💰💰💰 | ⭐⭐⭐⭐⭐ |
| `anthropic/claude-3.5-sonnet` | ⚡⚡ | 💰💰 | ⭐⭐⭐⭐⭐ |

**Для production используйте `gpt-4o-mini`** - оптимальное соотношение цена/качество.

---

## Fallback (без AI)

Если OpenRouter API не настроен, используется простой regex парсинг:
- Телефон: `/(\+7|8)[\d\-\(\)\s]+/`
- Имя: `/"Имя: (.+)"/` или первое слово с заглавной
- Адрес: `/ул\.|улица|пр\./`
- Дата: `/\d{4}-\d{2}-\d{2}/`

Это работает, но менее точно чем AI.

---

## Следующие шаги

1. ✅ **Протестировать webhook** с новой логикой
2. ✅ **Добавить кнопку "Обработать AI"** в карточку сделки
3. ✅ **Настроить автоматическую AI обработку** для новых заявок
4. ✅ **Добавить индикатор** "⏳ Обрабатывается AI..." в UI

**Хотите, чтобы я добавил кнопку AI в карточку сделки?** 🚀
